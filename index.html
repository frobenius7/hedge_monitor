<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeBank + Hyperliquid ‚Äî Totals Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for the net_usd_value history chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .json-key { color:#0369a1 }
    .json-number { color:#a16207 }
    .json-string { color:#16a34a }
    .json-null { color:#ef4444 }
  </style>
</head>
<body class="min-h-full bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">Supabase Totals <span class="text-slate-400">(DeBank stats + HL equity)</span></h1>
      <button id="toggleTheme" class="px-3 py-1.5 rounded-xl border border-slate-300 text-sm">üåô –¢–µ–º–∞</button>
    </header>

    <section class="mt-4 grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold text-lg mb-3">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="block">
            <span class="text-sm text-slate-600">SUPABASE_URL</span>
            <input id="sbUrl" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300" placeholder="https://YOUR-PROJECT.supabase.co" />
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">SUPABASE_ANON_KEY</span>
            <input id="sbKey" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300" placeholder="eyJhbGciOi..." />
          </label>
        </div>
        <div class="grid sm:grid-cols-3 gap-3 mt-3">
          <label class="block">
            <span class="text-sm text-slate-600">–¢–∞–±–ª–∏—Ü–∞ DeBank</span>
            <input id="tblDeBank" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300" value="debank_protocols" />
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">–¢–∞–±–ª–∏—Ü–∞ Hyperliquid</span>
            <input id="tblHL" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300" value="hyperliquid_state" />
          </label>
          <label class="block">
            <span class="text-sm text-slate-600">–ê–¥—Ä–µ—Å (–∫–æ—à–µ–ª—ë–∫)</span>
            <input id="address" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-300" placeholder="0x..." />
          </label>
        </div>
        <div class="flex flex-wrap items-center gap-3 mt-4">
          <label class="inline-flex items-center gap-2 text-sm mr-2">
            <input id="allWallets" type="checkbox" class="w-4 h-4">
            <span>–ü–æ –≤—Å–µ–º –∞–¥—Ä–µ—Å–∞–º</span>
          </label>
          <button id="connectBtn" class="px-4 py-2 rounded-2xl bg-slate-900 text-white">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
          <button id="loadBtn" class="px-4 py-2 rounded-2xl bg-blue-600 text-white disabled:opacity-50" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
        <p class="text-xs text-slate-500 mt-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π <code class="mono">anon</code> –∫–ª—é—á, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ RLS –Ω–∞ SELECT. –í –±—Ä–∞—É–∑–µ—Ä–µ <b>–Ω–µ</b> –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ <code class="mono">service_role</code>.</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold text-lg mb-3">–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è</h2>
        <ul class="text-sm text-slate-700 list-disc list-inside space-y-1">
          <li><b>–¢–∞–±–ª–∏—Ü–∞ 1</b> (DeBank): –ø–æ–∫–∞–∑—ã–≤–∞–µ–º <code class="mono">stats.net_usd_value</code>, <code class="mono">stats.debt_usd_value</code>, <code class="mono">stats.asset_usd_value</code> –ø–æ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ.</li>
          <li><b>–¢–∞–±–ª–∏—Ü–∞ 2</b> (Hyperliquid): equity –ø–æ –∫–∞–∂–¥–æ–º—É –∞–¥—Ä–µ—Å—É (–±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∞–ø—à–æ—Ç).</li>
          <li><b>–ò—Ç–æ–≥–æ</b>: —Å—É–º–º–∞ <code class="mono">net_usd_value</code> –∏–∑ –¢–∞–±–ª–∏—Ü—ã 1 + —Å—É–º–º–∞ equity –∏–∑ –¢–∞–±–ª–∏—Ü—ã 2.</li>
        </ul>
      </div>
    </section>

    <!-- Totals -->
    <section id="totals" class="mt-6 grid md:grid-cols-3 gap-4"></section>

    <!-- Net chart -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h3 class="font-semibold mb-3">–ì—Ä–∞—Ñ–∏–∫ ‚Äî Œ£ net_usd_value (–ø–æ fetched_at)</h3>
      <canvas id="chartNet" height="220"></canvas>
    </section>

    <!-- Equity chart -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h3 class="font-semibold mb-3">–ì—Ä–∞—Ñ–∏–∫ ‚Äî Œ£ equity (–ø–æ fetched_at)</h3>
      <canvas id="chartEq" height="220"></canvas>
    </section>

    <!-- Tables -->
    <section class="mt-6 grid lg:grid-cols-2 gap-4">
      <div class="bg-white rounded-2xl shadow p-4 overflow-auto">
        <h3 class="font-semibold mb-3">–¢–∞–±–ª–∏—Ü–∞ 1 ‚Äî DeBank stats</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="t1">
            <thead class="bg-slate-100">
              <tr id="t1_head"></tr>
            </thead>
            <tbody id="t1_body" class="divide-y"></tbody>
          </table>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 overflow-auto">
        <h3 class="font-semibold mb-3">–¢–∞–±–ª–∏—Ü–∞ 2 ‚Äî Hyperliquid equity (–ø–æ –∞–¥—Ä–µ—Å–∞–º)</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="t2">
            <thead class="bg-slate-100">
              <tr id="t2_head"></tr>
            </thead>
            <tbody id="t2_body" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- JSON for debug -->
    <section class="mt-6 bg-white rounded-2xl shadow p-4">
      <h3 class="font-semibold mb-3">Debug JSON</h3>
      <div id="jsonTree" class="mono text-xs whitespace-pre-wrap"></div>
    </section>

    <!-- Self tests -->
    <section class="mt-8 bg-white rounded-2xl shadow p-4">
      <details>
        <summary class="cursor-pointer font-semibold">üß™ Self tests</summary>
        <div class="mt-3 text-sm" id="testsOut"></div>
        <button id="runTests" class="mt-3 px-3 py-1.5 rounded-xl border">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã</button>
      </details>
    </section>

    <footer class="text-center text-xs text-slate-500 mt-10">¬© Totals Viewer</footer>
  </div>

  <script>
    // Theme
    const toggleBtn = document.getElementById('toggleTheme');
    toggleBtn.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      document.body.classList.toggle('bg-slate-900');
      document.body.classList.toggle('text-slate-100');
    });

    let sb = null;
    const qs = (id) => document.getElementById(id);

    qs('connectBtn').addEventListener('click', () => {
      const url = qs('sbUrl').value.trim();
      const key = qs('sbKey').value.trim();
      if (!url || !key) return alert('–£–∫–∞–∂–∏—Ç–µ SUPABASE_URL –∏ SUPABASE_ANON_KEY');
      try {
        if (!window.supabase || !window.supabase.createClient) throw new Error('Supabase UMD –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª—Å—è');
        sb = window.supabase.createClient(url, key);
        qs('loadBtn').disabled = false;
      } catch (e) {
        console.error(e); alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Supabase');
      }
    });

    qs('loadBtn').addEventListener('click', async () => {
      if (!sb) return alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ Supabase');
      const tableDeBank = qs('tblDeBank').value || 'debank_protocols';
      const tableHL = qs('tblHL').value || 'hyperliquid_state';
      const allWallets = qs('allWallets').checked;
      const address = (qs('address').value || '').toLowerCase();
      if (!allWallets && !address) return alert('–õ–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å, –ª–∏–±–æ –≤–∫–ª—é—á–∏—Ç–µ ¬´–ü–æ –≤—Å–µ–º –∞–¥—Ä–µ—Å–∞–º¬ª.');

      // 1) Fetch DeBank rows with raw.stats
      let qd = sb.from(tableDeBank).select('address,protocol_id,raw,fetched_at');
      if (!allWallets) qd = qd.eq('address', address);
      const { data: drows, error: derr } = await qd.limit(20000);
      if (derr) { console.error(derr); return alert('–û—à–∏–±–∫–∞ DeBank: '+derr.message); }

      const debankStatsRows = (drows||[]).map(r => {
        const st = extractDeBankStatsFromRaw(r.raw);
        return {
          address: r.address,
          protocol_id: r.protocol_id,
          net_usd_value: st.net,
          debt_usd_value: st.debt,
          asset_usd_value: st.asset,
          fetched_at: r.fetched_at
        };
      });

      // 2) Build Œ£(net) by fetched_at and find latest snapshot sum
      const sumByTsMap = new Map();
      for (const r of debankStatsRows){
        const ts = r.fetched_at;
        const v = Number(r.net_usd_value) || 0;
        sumByTsMap.set(ts, (sumByTsMap.get(ts) || 0) + v);
      }
      const labels = [...sumByTsMap.keys()].sort();
      const series = labels.map(ts => sumByTsMap.get(ts));
      const latestTs = labels.length ? labels[labels.length - 1] : null;
      const sumDeBankNetLatest = latestTs ? (sumByTsMap.get(latestTs) || 0) : 0;

      // 3) Fetch Hyperliquid rows and keep latest per address
      let qh = sb.from(tableHL).select('address,equity_usd,raw,fetched_at').order('fetched_at', { ascending: false });
      if (!allWallets) qh = qh.eq('address', address);
      const { data: hrows, error: herr } = await qh.limit(20000);
      // Build Œ£(equity) by fetched_at for chart
      const sumHLByTsMap = new Map();
      for (const r of (hrows||[])){
        const v = Number(r.equity_usd) || extractHLEquityFromRaw(r.raw) || 0;
        const ts = r.fetched_at;
        sumHLByTsMap.set(ts, (sumHLByTsMap.get(ts) || 0) + v);
      }
      const labelsEq = [...sumHLByTsMap.keys()].sort();
      const seriesEq = labelsEq.map(ts => sumHLByTsMap.get(ts));
      if (herr) { console.error(herr); return alert('–û—à–∏–±–∫–∞ Hyperliquid: '+herr.message); }
      // –í—Å–µ —Å—Ç—Ä–æ–∫–∏ HL (–¥–ª—è —Ç–∞–±–ª–∏—Ü—ã)
      const hlRowsAll = (hrows || []).map(r => ({
        address: r.address,
        equity_usd: Number(r.equity_usd) || extractHLEquityFromRaw(r.raw) || 0,
        fetched_at: r.fetched_at
      }));

      // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –∞–¥—Ä–µ—Å—É (–¥–ª—è —Ç–æ—Ç–∞–ª–æ–≤)
      const latestByAddr = new Map();
      for (const r of (hrows||[])){
        if (!latestByAddr.has(r.address)) latestByAddr.set(r.address, r);
      }
      const hlLatestRows = [...latestByAddr.values()].map(r => ({
        address: r.address,
        equity_usd: Number(r.equity_usd) || extractHLEquityFromRaw(r.raw) || 0,
        fetched_at: r.fetched_at
      }));
      const sumHLEquity = hlLatestRows.reduce((a,x)=>a + (Number(x.equity_usd)||0), 0);

      // 4) Render tables & totals
      renderTable1(debankStatsRows);
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
      hlRowsAll.sort((a,b)=> String(b.fetched_at).localeCompare(String(a.fetched_at)) );
      renderTable2(hlRowsAll);
      renderTotals(sumDeBankNetLatest, sumHLEquity);

      // 5) Chart
      renderNetChart(labels, series);
      renderEquityChart(labelsEq, seriesEq);

      // Debug JSON
      renderJSON({ debankStatsRows, hlRows, latestTs, sumDeBankNetLatest });
    });

    function renderTable1(rows){
      const head = qs('t1_head'); const body = qs('t1_body');
      head.innerHTML = '';
      body.innerHTML = '';
      const cols = ['address','protocol_id','net_usd_value','debt_usd_value','asset_usd_value','fetched_at'];
      head.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-left text-slate-600">${c}</th>`).join('');
      for (const r of rows){
        const tr = document.createElement('tr'); tr.className='hover:bg-slate-50';
        tr.innerHTML = cols.map(c=>`<td class="px-3 py-2">${escapeHtml(r[c])}</td>`).join('');
        body.appendChild(tr);
      }
      if (!rows.length) body.innerHTML = `<tr><td class="px-3 py-2" colspan="${cols.length}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }

    function renderTable2(rows){
      const head = qs('t2_head'); const body = qs('t2_body');
      head.innerHTML = '';
      body.innerHTML = '';
      const cols = ['address','equity_usd','fetched_at'];
      head.innerHTML = cols.map(c=>`<th class="px-3 py-2 text-left text-slate-600">${c}</th>`).join('');
      for (const r of rows){
        const tr = document.createElement('tr'); tr.className='hover:bg-slate-50';
        tr.innerHTML = cols.map(c=>`<td class="px-3 py-2">${escapeHtml(r[c])}</td>`).join('');
        body.appendChild(tr);
      }
      if (!rows.length) body.innerHTML = `<tr><td class="px-3 py-2" colspan="${cols.length}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    }

    let netChart = null, eqChart = null;
    function renderTotals(dbNet, hlEq){
      const wrap = qs('totals');
      const card = (title, value) => `<div class="bg-white rounded-2xl shadow p-4"><div class="text-xs text-slate-500">${title}</div><div class="text-3xl font-bold">${formatUsd(value)}</div></div>`;
      wrap.innerHTML = [
        card('DeBank (Œ£ stats.net_usd_value)', dbNet),
        card('Hyperliquid (Œ£ equity)', hlEq),
        card('–ò—Ç–æ–≥–æ', dbNet + hlEq)
      ].join('');
    }

    function renderJSON(obj){
      qs('jsonTree').innerHTML = jsonToHtml(obj);
    }

    function renderNetChart(labels, series){
      const ctx = document.getElementById('chartNet');
      if (!ctx) return;
      if (netChart) netChart.destroy();
      netChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Œ£ net_usd_value', data: series, tension: 0.25 }] },
        options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
      });
    }

    function renderEquityChart(labels, series){
      const ctx = document.getElementById('chartEq');
      if (!ctx) return;
      if (eqChart) eqChart.destroy();
      eqChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label: 'Œ£ equity', data: series, tension: 0.25 }] },
        options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
      });
    }

    // Helpers
    function escapeHtml(v){ return (v===undefined||v===null)?'':String(v).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
    function formatUsd(v){ return new Intl.NumberFormat('en-US', {maximumFractionDigits: 2}).format(Number(v)||0); }

    function jsonToHtml(value, keyName=null, level=0){
      const pad='&nbsp;'.repeat(level*2);
      if (value===null) return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}<span class=\"json-null\">null</span>`;
      if (Array.isArray(value)){
        const items=value.map(v=>`<div>${jsonToHtml(v,null,level+1)}</div>`).join('');
        return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}[<div>${items}</div>${pad}]`;
      }
      if (typeof value==='object'){
        const inner=Object.keys(value).map(k=>`<div>${jsonToHtml(value[k],k,level+1)}</div>`).join('');
        return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}{<div>${inner}</div>${pad}}`;
      }
      if (typeof value==='number') return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}<span class=\"json-number\">${value}</span>`;
      if (typeof value==='string') return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}<span class=\"json-string\">\"${escapeHtml(value)}\"</span>`;
      return `${pad}${keyName?`<span class=\"json-key\">\"${keyName}\"</span>: `:''}${String(value)}`;
    }

    // Extraction
    function extractDeBankStatsFromRaw(raw){
      // Returns { net, debt, asset } from various DeBank payload shapes.
      const res = { net:0, debt:0, asset:0 };
      // Some drivers may deliver jsonb as string; normalize to object
      const toObj = (x)=>{
        if (!x) return {};
        if (typeof x === 'string') { try { return JSON.parse(x); } catch { return {}; } }
        return x;
      };
      const num = (x)=> (typeof x === 'number' ? x : (typeof x === 'string' && isFinite(Number(x)) ? Number(x) : 0));
      const obj = toObj(raw);

      // 1) Direct stats
      const s = obj.stats || obj.Stats || null;
      if (s && typeof s === 'object'){
        res.net   = num(s.net_usd_value);
        res.debt  = num(s.debt_usd_value);
        res.asset = num(s.asset_usd_value);
        if (res.net || res.debt || res.asset) return res;
      }

      // 2) Aggregate from common containers
      const containers = [
        'portfolio_item_list','portfolioItemList','portfolio_list','portfolio','items','positions','position_list','supply_position_list','borrow_position_list'
      ];
      let netSum=0, assetSum=0, debtSum=0, found=false;
      for (const key of containers){
        const arr = obj[key];
        if (!Array.isArray(arr)) continue;
        for (const it of arr){
          const st = it && it.stats;
          if (st && typeof st === 'object'){
            netSum  += num(st.net_usd_value);
            assetSum+= num(st.asset_usd_value ?? st.usd_value);
            debtSum += num(st.debt_usd_value);
            found = true;
          }
          const tokens = it && (it.token_list || it.tokens || it.assets || it.holdings);
          if (Array.isArray(tokens)){
            for (const t of tokens){
              if (t && t.stats){
                netSum  += num(t.stats.net_usd_value);
                assetSum+= num(t.stats.asset_usd_value ?? t.stats.usd_value);
                debtSum += num(t.stats.debt_usd_value);
                found = true;
              } else if (t && (t.usd_value !== undefined)){
                assetSum += num(t.usd_value);
              } else if (t && t.stats && (t.stats.usd_value !== undefined)){
                assetSum += num(t.stats.usd_value);
              }
            }
          }
        }
      }
      if (found || netSum || assetSum || debtSum){
        return { net: netSum || (assetSum - debtSum), debt: debtSum, asset: assetSum };
      }

      // 3) Last resort direct fields on root
      const n = num(obj.net_usd_value), d = num(obj.debt_usd_value), a = num(obj.asset_usd_value);
      return { net: n || (a - d), debt: d, asset: a };
    }

    function extractHLEquityFromRaw(raw){
      try {
        if (!raw || typeof raw !== 'object') return 0;
        const pick = (...paths) => {
          for (const p of paths){
            let node = raw; let ok = true;
            for (const k of p){ node = (node||{})[k]; if (node === undefined) { ok=false; break; } }
            if (ok && typeof node === 'number') return node;
            if (ok && typeof node === 'string' && !isNaN(Number(node))) return Number(node);
          }
          return null;
        };
        const v = pick(['accountValue'], ['equity'], ['equityUsd'], ['account_value'],
                       ['crossMarginSummary','accountValue'], ['state','accountValue'], ['marginSummary','equity']);
        return typeof v === 'number' ? v : 0;
      } catch { return 0; }
    }

    // Self tests
    qs('runTests').addEventListener('click', () => {
      const out = qs('testsOut');
      const lines = [];
      const assertEq = (name, got, want) => lines.push(`${Math.abs(Number(got)-Number(want))<1e-9?'‚úÖ':'‚ùå'} ${name}: got=${got} want=${want}`);

      const dbRaw = { stats: { net_usd_value: 10, debt_usd_value: 3, asset_usd_value: 13 } };
      const est = extractDeBankStatsFromRaw(dbRaw);
      assertEq('DeBank stats.net', est.net, 10);
      assertEq('DeBank stats.debt', est.debt, 3);
      assertEq('DeBank stats.asset', est.asset, 13);

      const hlRaw = { userAccountSummary:{ marginSummary:{ equity: 77 } } };
      assertEq('HL equity nested', extractHLEquityFromRaw(hlRaw), 77);

      // Additional tests for DeBank aggregated shapes
      const dbAgg = { portfolio_item_list: [
        { stats: { net_usd_value: 10, debt_usd_value: 2, asset_usd_value: 12 } },
        { token_list: [ { stats: { net_usd_value: 4, asset_usd_value: 5, debt_usd_value: 1 } } ] }
      ]};
      const est2 = extractDeBankStatsFromRaw(dbAgg);
      assertEq('DeBank aggregated net', est2.net, 14);
      assertEq('DeBank aggregated debt', est2.debt, 3);
      assertEq('DeBank aggregated asset', est2.asset, 17);

      // Extra: numeric strings and root fallbacks
      const dbStr = { stats: { net_usd_value: "15.5", debt_usd_value: "1.5", asset_usd_value: "17" } };
      const est3 = extractDeBankStatsFromRaw(dbStr);
      assertEq('DeBank numeric strings', est3.net, 15.5);

      const dbRoot = { asset_usd_value: 20, debt_usd_value: 4 };
      const est4 = extractDeBankStatsFromRaw(dbRoot);
      assertEq('DeBank root fallback net', est4.net, 16);

      out.innerText = lines.join('\n');
    });
  </script>
</body>
</html>
